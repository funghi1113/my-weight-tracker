<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>æ¸›é‡è¨ˆç•«ç´€éŒ„ App</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ---------------- 1. å…¨å±€è®Šæ•¸èˆ‡é‡ç½® ---------------- */
    :root {
      --bg: #f4f7f6;            /* èƒŒæ™¯è‰² */
      --card-bg: #ffffff;       /* å¡ç‰‡ç™½ */
      --primary: #2e7d32;       /* ä¸»è‰²ç¶  */
      --primary-light: #e8f5e9; 
      --text-main: #333333;     
      --text-sub: #757575;      
      --border: #e0e0e0;        
      --shadow: 0 8px 24px rgba(0,0,0,0.06); /* æ›´æŸ”å’Œçš„é™°å½± */
      
      /* åŠŸèƒ½è‰² */
      --google-blue: #4285F4;
      
      /* åœ“è§’ */
      --radius-card: 18px;
      --radius-btn: 14px;
    }

    body { 
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background: var(--bg); color: var(--text-main); padding-bottom: 60px; 
      -webkit-font-smoothing: antialiased;
    }

    /* ---------------- 2. å°èˆªåˆ— ---------------- */
    header { 
        display: flex; justify-content: center; gap: 15px; padding: 15px 20px; 
        background: rgba(255,255,255,0.95); position: sticky; top: 0; z-index: 100; 
        backdrop-filter: blur(10px); border-bottom: 1px solid var(--border);
    }
    header button { 
        background: transparent; border: none; color: var(--text-sub); 
        font-size: 15px; font-weight: 600; padding: 8px 16px; border-radius: 30px;
        transition: all 0.2s ease; cursor: pointer;
    }
    header button.active { 
        background: var(--primary-light); color: var(--primary); 
    }

    /* ---------------- 3. å¡ç‰‡èˆ‡ç‰ˆé¢ (ä¿®æ­£è²¼é‚Šå•é¡Œ) ---------------- */
    .page { 
        display: none; 
        padding: 24px 20px; /* åŠ å¤§é é¢å·¦å³é‚Šè·ï¼Œè®“å¡ç‰‡ä¸è¦è²¼è‘—è¢å¹• */
        max-width: 600px; margin: 0 auto; 
        animation: fadeIn 0.4s ease; 
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .card { 
        background: var(--card-bg); 
        padding: 24px; /* å¢åŠ å¡ç‰‡å…§éƒ¨ç•™ç™½ï¼Œè®“æ–‡å­—ä¸è¦è²¼é‚Š */
        border-radius: var(--radius-card); 
        margin-bottom: 20px; 
        box-shadow: var(--shadow); 
        border: 1px solid transparent;
        transition: transform 0.2s;
        position: relative;
    }
    /* å·¦å´è£é£¾ç·š */
    .card.accent-border { border-left: 5px solid var(--primary); }
    
    /* æ¨™é¡Œæ¨£å¼ */
    h2 { margin: 0 0 18px 0; font-size: 1.2rem; color: var(--text-main); font-weight: 700; display: flex; align-items: center; gap: 8px; }
    h3 { margin: 0 0 12px 0; font-size: 1.05rem; color: var(--text-main); font-weight: 600; }

    /* ---------------- 4. è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• ---------------- */
    label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-sub); font-weight: 500; }
    
    input, textarea { 
        width: 100%; padding: 14px; border-radius: var(--radius-btn); 
        border: 1px solid #cfd8dc; background: #fff; color: var(--text-main); 
        font-size: 16px; box-sizing: border-box; transition: border 0.2s; margin-bottom: 16px;
    }
    input:focus, textarea:focus { outline: none; border-color: var(--primary); background: #fff; }

    .btn-main { 
        width: 100%; padding: 16px; border: none; border-radius: var(--radius-btn);
        background: var(--primary); color: white; font-size: 16px; font-weight: 600; 
        cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        box-shadow: 0 4px 12px rgba(46, 125, 50, 0.25); transition: filter 0.2s;
    }
    .btn-main:active { filter: brightness(0.9); transform: scale(0.98); }
    
    .btn-outline {
        background: white; color: var(--primary); border: 1px solid var(--primary);
        box-shadow: none;
    }

    /* ---------------- 5. æ­·å²ç´€éŒ„åˆ—è¡¨ (ä¿®æ­£æ’ç‰ˆ) ---------------- */
    /* é€™è£¡ç§»é™¤äº†éŒ¯èª¤çš„ padding è¨­å®š */
    .log-item { 
        display: flex; flex-direction: column; gap: 10px;
        /* é€™è£¡ä¸éœ€è¦ paddingï¼Œå› ç‚º .card å·²ç¶“æœ‰äº† 24px padding */
        cursor: pointer;
    }

    .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .log-date { font-size: 1.1rem; font-weight: 700; color: var(--text-main); letter-spacing: 0.5px; }
    
    .log-actions { display: flex; gap: 8px; }
    .btn-mini { 
        padding: 6px 14px; font-size: 13px; border-radius: 8px; border: none; cursor: pointer; 
        font-weight: 500; background: #f5f5f5; color: var(--text-sub);
    }
    .btn-mini:active { background: #e0e0e0; }
    .btn-mini.edit { background: #e3f2fd; color: #1565c0; }
    .btn-mini.del { background: #ffebee; color: #c62828; }

    .log-stats { display: flex; align-items: baseline; gap: 12px; }
    .log-weight { font-size: 1.8rem; font-weight: 800; color: var(--primary); line-height: 1; }
    .log-unit { font-size: 1rem; color: var(--text-sub); font-weight: 500; }
    .log-bmi { 
        font-size: 0.9rem; padding: 4px 10px; border-radius: 6px; 
        background: var(--primary-light); color: var(--primary); font-weight: 600; 
    }

    .log-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
    .tag { 
        font-size: 0.85rem; color: var(--text-sub); background: #f0f2f5; 
        padding: 6px 12px; border-radius: 8px; width: 100%;
        /* å¦‚æœå…§å®¹å¤ªé•·ï¼Œè®“å®ƒè®Šçœç•¥è™Ÿ */
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* ---------------- 6. å…¶ä»–çµ„ä»¶ ---------------- */
    .backup-row { display: flex; gap: 12px; margin-top: 12px; }
    .backup-row button { flex: 1; margin: 0; }

    .filter-btn-group { display: flex; background: #eceff1; padding: 4px; border-radius: 14px; margin-bottom: 24px; }
    .filter-btn-group button { flex: 1; background: transparent; color: var(--text-sub); padding: 10px; border-radius: 10px; border:none; font-size:14px; font-weight: 500; }
    .filter-btn-group button.active { background: white; color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.08); font-weight: 700; }

    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .stat-box { background: #ffffff; padding: 20px; border-radius: 16px; text-align: center; border: 1px solid var(--border); box-shadow: var(--shadow); }
    .stat-val { font-size: 1.6rem; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 0.85rem; color: var(--text-sub); margin-top: 6px; }

    .chart-container { position: relative; height: 240px; width: 100%; }

    /* BMI Spectrum */
    .spectrum-bar { height: 14px; border-radius: 7px; position: relative; margin: 35px 0 25px 0; background: linear-gradient(to right, #4fc3f7 0%, #4fc3f7 17.5%, #66bb6a 17.5%, #66bb6a 45%, #ffa726 45%, #ffa726 60%, #ef5350 60%, #ef5350 100%); }
    .spectrum-marker { position: absolute; top: -16px; width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-top: 11px solid #333; transform: translateX(-50%); transition: left 0.5s ease; }
    
    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-overlay.show { display: flex; }
    .modal-content { background: white; width: 85%; max-width: 420px; border-radius: 24px; padding: 28px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed var(--border); }
    .detail-label { color: var(--text-sub); font-size: 0.95rem; }
    .detail-val { color: var(--text-main); font-weight: 600; text-align: right; max-width: 65%; line-height: 1.4; }
  </style>
</head>
<body>

  <header>
    <button id="tab-today" class="active" onclick="switchTab('today')">ä»Šæ—¥ç´€éŒ„</button>
    <button id="tab-history" onclick="switchTab('history')">æ­·å²ç´€éŒ„</button>
    <button id="tab-dashboard" onclick="switchTab('dashboard')">åˆ†æå„€è¡¨æ¿</button>
  </header>

  <!-- 1. ä»Šæ—¥ç´€éŒ„ -->
  <div id="page-today" class="page" style="display:block;">
    
    <div class="card accent-border">
        <h2>âš™ï¸ å€‹äººæª”æ¡ˆ & ç›®æ¨™</h2>
        <div style="display:flex; gap:16px;">
            <div style="flex:1"><label>èº«é«˜ (cm)</label><input type="number" id="userHeight" placeholder="170" oninput="calculateBMI()" /></div>
            <div style="flex:1"><label>ç›®æ¨™é«”é‡ (kg)</label><input type="number" id="userGoal" placeholder="60" oninput="calculateBMI()" /></div>
        </div>
        
        <div id="bmiContainer" style="display:none; margin-top:10px; padding-top:16px; border-top:1px dashed var(--border);">
            <div style="text-align:center; font-size:1.1rem; font-weight:bold; color:var(--text-main);">
                BMI <span id="bmiValue" style="color:var(--primary); font-size:1.6rem;">--</span>
                <span id="bmiCategory" style="font-size:0.85rem; padding:4px 10px; border-radius:6px; color:white; background:#ccc; vertical-align:middle; margin-left:6px;">--</span>
            </div>
            <div class="spectrum-bar">
                <div id="bmiMarker" class="spectrum-marker"></div>
            </div>
            <div id="goalDiffText" style="text-align:center; font-size:0.95rem; color:var(--text-sub); margin-top:15px;"></div>
        </div>
        <div id="bmiPlaceholder" style="text-align:center; color:var(--text-sub); font-size:0.9rem; padding:10px;">è«‹è¼¸å…¥èº«é«˜èˆ‡ä»Šæ—¥é«”é‡ä»¥æŸ¥çœ‹åˆ†æ</div>
    </div>

    <form id="trackerForm">
      <div class="card">
        <h2>ğŸ“… åŸºæœ¬è³‡æ–™</h2>
        <label>æ—¥æœŸ</label><input type="date" name="date" required />
        <div style="display:flex; gap:16px;">
            <div style="flex:1"><label>ä»Šæ—¥é«”é‡ (kg)</label><input type="number" name="weight" id="inputWeight" step="0.1" placeholder="0.0" oninput="calculateBMI()" /></div>
            <div style="flex:1"><label>å–æ°´é‡ (ml)</label><input type="number" name="water" placeholder="0" /></div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ½ï¸ é£²é£Ÿæ”å–</h2>
        <label>ç¸½ç†±é‡ (kcal)</label><input type="number" name="calories" placeholder="é¸å¡«" />
        <label>æ—©é¤</label><textarea name="breakfast" rows="1" placeholder="åƒäº†ä»€éº¼ï¼Ÿ"></textarea>
        <label>åˆé¤</label><textarea name="lunch" rows="1"></textarea>
        <label>æ™šé¤</label><textarea name="dinner" rows="1"></textarea>
        <label>é»å¿ƒ</label><textarea name="snacks" rows="1"></textarea>
      </div>

      <div class="card">
        <h2>ğŸƒ é‹å‹•èˆ‡å‚™è¨»</h2>
        <label>é‹å‹•å…§å®¹</label><textarea name="exercise" rows="1"></textarea>
        <div style="display:flex; gap:16px;">
            <div style="flex:1"><label>é‹å‹•æ™‚é•· (åˆ†)</label><input type="number" name="exercise_time" /></div>
        </div>
        <label>å¿ƒæƒ… / å‚™è¨»</label><textarea name="notes" rows="2"></textarea>
      </div>

      <button type="submit" class="btn-main">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
    </form>
  </div>

  <!-- 2. æ­·å²ç´€éŒ„ (ä¿®å¾©ç‰ˆ) -->
  <div id="page-history" class="page">
    <h2>ğŸ“’ æ­·å²ç´€éŒ„</h2>
    
    <!-- é›²ç«¯åŒæ­¥ -->
    <div class="card accent-border">
        <h3>â˜ï¸ é›²ç«¯åŒæ­¥ (Google Sheets)</h3>
        <div style="font-size:0.9rem; color:var(--text-sub); margin-bottom:16px; line-height:1.5;">
            å°‡è³‡æ–™åŒæ­¥åˆ°æ‚¨çš„å°ˆå±¬é›²ç«¯è©¦ç®—è¡¨ï¼Œæ›æ‰‹æ©Ÿä¹Ÿä¸æ€•ã€‚
        </div>
        <div class="backup-row">
            <button onclick="uploadToCloud()" class="btn-main">â¬†ï¸ ä¸Šå‚³</button>
            <button onclick="downloadFromCloud()" class="btn-main btn-outline">â¬‡ï¸ ä¸‹è¼‰</button>
        </div>
    </div>

    <!-- æœ¬åœ°å‚™ä»½ -->
    <div class="card accent-border" style="border-left-color: #607d8b;">
        <h3>ğŸ’¾ æœ¬åœ°å‚™ä»½ (JSON æª”æ¡ˆ)</h3>
        <div style="font-size:0.9rem; color:var(--text-sub); margin-bottom:16px; line-height:1.5;">
            å°‡è³‡æ–™åŒ¯å‡ºæˆæª”æ¡ˆä¿å­˜ï¼Œæˆ–å¾æª”æ¡ˆé‚„åŸã€‚
        </div>
        <div class="backup-row">
            <button onclick="exportData()" class="btn-main" style="background:#607d8b; border-color:#607d8b;">åŒ¯å‡º</button>
            <button onclick="document.getElementById('importFile').click()" class="btn-main btn-outline" style="color:#607d8b; border-color:#607d8b;">åŒ¯å…¥</button>
            <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)" />
        </div>
    </div>

    <!-- åˆ—è¡¨å€ -->
    <div id="historyList"></div>
  </div>

  <!-- 3. åˆ†æå„€è¡¨æ¿ -->
  <div id="page-dashboard" class="page">
    <h2>ğŸ“Š æ•¸æ“šåˆ†æ</h2>
    <div class="filter-btn-group">
        <button onclick="updateDashboard(7)" id="btn-7">7 å¤©</button>
        <button onclick="updateDashboard(30)" id="btn-30">30 å¤©</button>
        <button onclick="updateDashboard('all')" id="btn-all">å…¨éƒ¨</button>
    </div>
    
    <div class="stats-grid" style="margin-bottom:20px;">
        <div class="stat-box"><div class="stat-val" id="avgWeight">--</div><div class="stat-label">å¹³å‡é«”é‡ (kg)</div></div>
        <div class="stat-box"><div class="stat-val" id="avgCalories">--</div><div class="stat-label">å¹³å‡ç†±é‡ (kcal)</div></div>
    </div>

    <div class="card">
        <h3>ğŸ“ˆ é«”é‡è¶¨å‹¢</h3>
        <div class="chart-container"><canvas id="weightChart"></canvas></div>
    </div>

    <div class="card">
        <h3>âš–ï¸ BMI è®ŠåŒ–</h3>
        <div class="chart-container"><canvas id="bmiChart"></canvas></div>
    </div>

    <div class="card">
        <h3>ğŸ’§ é£²é£Ÿèˆ‡ç†±é‡</h3>
        <div class="chart-container"><canvas id="dietChart"></canvas></div>
    </div>

    <div class="card">
        <h3>ğŸƒ é‹å‹•æ™‚é•·</h3>
        <div class="chart-container"><canvas id="exerciseChart"></canvas></div>
    </div>
  </div>

  <!-- Modal è©³ç´°è¦–çª— -->
  <div id="detailModal" class="modal-overlay" onclick="closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
              <h2 style="margin:0; font-size:1.5rem;">ğŸ“… <span id="modalDate"></span></h2>
              <button onclick="closeModal()" style="background:none; border:none; font-size:1.8rem; color:#ccc; cursor:pointer;">&times;</button>
          </div>
          <div id="modalBody"></div>
          <button id="modalEditBtn" class="btn-main" style="margin-top:24px;">âœï¸ ä¿®æ”¹æ­¤ç´€éŒ„</button>
      </div>
  </div>

<script>
  // ------------------ é‚è¼¯å€ ------------------
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwvOSjRRC5VDaLzU_PsoAlpgQb4iHaSYePTrMZs9ZZ6NeeE51T4LQNYtvNWSVqlJCg88Q/exec";
  const STORAGE_KEY = 'weightTrackerLogs';
  const SETTINGS_KEY = 'weightTrackerSettings'; 
  let allLogs = []; 
  let charts = { weight: null, bmi: null, diet: null, exercise: null };

  window.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    allLogs = loadLogs();
    document.querySelector('input[name="date"]').valueAsDate = new Date();
    calculateBMI();
  });

  // Helper
  function cleanDate(d) { return d && d.includes('T') ? d.split('T')[0] : d; }
  function getBMI(w, h) { return (w && h) ? (w / ((h/100)**2)).toFixed(1) : null; }

  // BMI & Settings
  function loadSettings() {
    const s = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
    if(s.height) document.getElementById('userHeight').value = s.height;
    if(s.goal) document.getElementById('userGoal').value = s.goal;
  }
  function calculateBMI() {
    const h = document.getElementById('userHeight').value;
    const w = document.getElementById('inputWeight').value;
    const g = document.getElementById('userGoal').value;
    
    if(h || g) localStorage.setItem(SETTINGS_KEY, JSON.stringify({ height: h, goal: g }));

    const hasData = h && w;
    document.getElementById('bmiPlaceholder').style.display = hasData ? 'none' : 'block';
    document.getElementById('bmiContainer').style.display = hasData ? 'block' : 'none';

    if(!hasData) return;

    const bmi = getBMI(w, h);
    document.getElementById('bmiValue').innerText = bmi;
    
    const cat = document.getElementById('bmiCategory');
    let color = '#66bb6a'; let text = 'æ­£å¸¸';
    if(bmi<18.5) { color='#4fc3f7'; text='éè¼•'; }
    else if(bmi>=24 && bmi<27) { color='#ffa726'; text='éé‡'; }
    else if(bmi>=27) { color='#ef5350'; text='è‚¥èƒ–'; }
    
    cat.innerText = text; cat.style.backgroundColor = color;
    
    let pct = ((bmi - 15) / 20) * 100;
    pct = Math.max(0, Math.min(100, pct));
    document.getElementById('bmiMarker').style.left = `${pct}%`;

    const diffBox = document.getElementById('goalDiffText');
    if(g) {
        const diff = (w - g).toFixed(1);
        if(diff > 0) diffBox.innerHTML = `è·é›¢ç›®æ¨™é‚„æœ‰ <b style="color:#ffa726">${diff}</b> kg`;
        else diffBox.innerHTML = `å·²é”æˆç›®æ¨™ï¼ä½æ–¼ <b style="color:#66bb6a">${Math.abs(diff)}</b> kg`;
    } else {
        diffBox.innerText = "è¨­å®šç›®æ¨™é«”é‡å¯æŸ¥çœ‹å·®è·";
    }
  }

  // CRUD
  function loadLogs() { 
      try { 
          return (JSON.parse(localStorage.getItem(STORAGE_KEY))||[])
            .map(l=>({...l, date:cleanDate(l.date)}))
            .sort((a,b)=>new Date(b.date)-new Date(a.date)); 
      } catch { return []; }
  }
  function saveLogs(logs) {
      const s = logs.map(l=>({...l, date:cleanDate(l.date)})).sort((a,b)=>new Date(b.date)-new Date(a.date));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); allLogs = s;
  }

  // Render History (ä¿®æ­£ç‰ˆï¼šå…§å®¹ä¸å†è²¼é‚Š)
  function renderHistory() {
    const list = document.getElementById('historyList'); list.innerHTML="";
    if(allLogs.length===0) { list.innerHTML='<p style="text-align:center;color:#999;margin-top:20px;">å°šç„¡ç´€éŒ„</p>'; return; }
    
    const h = parseFloat(document.getElementById('userHeight').value);

    allLogs.forEach((log,i) => {
      const d = document.createElement('div'); d.className='card log-item'; 
      d.onclick=()=>showDetails(i);

      let weightHtml = '', bmiHtml = '';
      if(log.weight) {
          weightHtml = `<span class="log-weight">${log.weight}</span><span class="log-unit">kg</span>`;
          if(h) {
              const bmi = getBMI(log.weight, h);
              let color = '#66bb6a'; 
              if(bmi>=24 && bmi<27) color='#ffa726'; 
              if(bmi>=27) color='#ef5350'; 
              bmiHtml = `<span class="log-bmi" style="color:${color}; background:${color}15">BMI ${bmi}</span>`;
          }
      }

      let tags = [];
      if(log.exercise) tags.push(`ğŸƒ é‹å‹•`);
      if(log.calories) tags.push(`ğŸ”¥ ${log.calories} cal`);
      if(log.notes) tags.push(`ğŸ“ å‚™è¨»`);
      const tagHtml = tags.length ? `<div class="log-tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>` : `<div class="tag">ç„¡è©³ç´°ç´€éŒ„</div>`;

      d.innerHTML = `
        <div class="log-header">
            <div class="log-date">${cleanDate(log.date)}</div>
            <div class="log-actions">
                <button class="btn-mini edit" onclick="event.stopPropagation();editLog(${i})">ä¿®æ”¹</button>
                <button class="btn-mini del" onclick="event.stopPropagation();deleteLog(${i})">åˆªé™¤</button>
            </div>
        </div>
        <div class="log-stats">
            ${weightHtml}
            ${bmiHtml}
        </div>
        ${tagHtml}
      `;
      list.appendChild(d);
    });
  }

  // Actions
  function deleteLog(i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { allLogs.splice(i,1); saveLogs(allLogs); renderHistory(); } }
  function editLog(i) {
      const l = allLogs[i]; const f = document.getElementById('trackerForm'); f.reset();
      for(const k in l) if(f[k]) f[k].value=l[k];
      f.date.value = cleanDate(l.date);
      closeModal(); switchTab('today'); calculateBMI(); window.scrollTo({top:0,behavior:'smooth'});
  }
  
  document.getElementById("trackerForm").addEventListener('submit', function(e) {
    e.preventDefault();
    const fd = new FormData(this); const n={};
    for(const [k,v] of fd.entries()) { if(v) n[k]=['weight','water','calories','exercise_time'].includes(k)?parseFloat(v):v; }
    if(!n.date) return alert("è«‹é¸æ—¥æœŸ");
    n.date = cleanDate(n.date);
    const idx = allLogs.findIndex(l=>l.date===n.date);
    if(idx!==-1) { if(!confirm(`è¦†è“‹ ${n.date} çš„ç´€éŒ„ï¼Ÿ`)) return; allLogs[idx]={...allLogs[idx],...n}; }
    else allLogs.unshift(n);
    saveLogs(allLogs); alert("å·²å„²å­˜"); this.reset();
    document.querySelector('input[name="date"]').valueAsDate=new Date(); calculateBMI();
  });

  function switchTab(t) {
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    document.querySelectorAll('header button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`page-${t}`).style.display='block';
    document.getElementById(`tab-${t}`).classList.add('active');
    if(t==='history') renderHistory();
    if(t==='dashboard') updateDashboard(7);
    if(t==='today') { 
        if(!document.querySelector('input[name="date"]').value) document.querySelector('input[name="date"]').valueAsDate=new Date();
        calculateBMI(); 
    }
  }

  // Modal
  function showDetails(i) {
      const l = allLogs[i]; const b=document.getElementById('modalBody');
      document.getElementById('modalDate').innerText = cleanDate(l.date);
      
      const row = (lbl,val) => val ? `<div class="detail-row"><span class="detail-label">${lbl}</span><span class="detail-val">${val}</span></div>` : '';
      
      let content = row('é«”é‡', l.weight?`${l.weight} kg`:'') + row('å–æ°´', l.water?`${l.water} ml`:'') + row('ç†±é‡', l.calories?`${l.calories} kcal`:'');
      if(l.breakfast) content += row('æ—©é¤', l.breakfast);
      if(l.lunch) content += row('åˆé¤', l.lunch);
      if(l.dinner) content += row('æ™šé¤', l.dinner);
      if(l.snacks) content += row('é»å¿ƒ', l.snacks);
      if(l.exercise) content += row('é‹å‹•', `${l.exercise} (${l.exercise_time||0}åˆ†)`);
      if(l.notes) content += row('å‚™è¨»', l.notes);

      b.innerHTML = content || '<p style="text-align:center;color:#999">ç„¡è©³ç´°è³‡æ–™</p>';
      document.getElementById('modalEditBtn').onclick=()=>editLog(i);
      document.getElementById('detailModal').classList.add('show');
  }
  function closeModal(e) { if(e && e.target!==e.currentTarget) return; document.getElementById('detailModal').classList.remove('show'); }

  // Cloud
  async function uploadToCloud() {
      if(!confirm("ç¢ºå®šä¸Šå‚³ï¼Ÿé€™å°‡è¦†è“‹é›²ç«¯è³‡æ–™ã€‚")) return;
      try {
          const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'backup', data: allLogs }) });
          const r = await res.json(); alert(r.status==='success'?r.msg:r.msg);
      } catch(e) { alert("é€£ç·šå¤±æ•—"); }
  }
  async function downloadFromCloud() {
      if(!confirm("ç¢ºå®šé‚„åŸï¼Ÿé€™å°‡è¦†è“‹æœ¬æ©Ÿè³‡æ–™ã€‚")) return;
      try {
          const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'restore' }) });
          const r = await res.json();
          if(r.status==='success') {
              const d = r.data.map(l=>({...l, date:cleanDate(l.date)}));
              saveLogs(d); renderHistory(); calculateBMI(); alert("é‚„åŸæˆåŠŸï¼");
          } else alert("ä¸‹è¼‰å¤±æ•—");
      } catch(e) { alert("é€£ç·šå¤±æ•—"); }
  }
  // File
  function exportData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(allLogs)],{type:'application/json'})); a.download=`backup.json`; a.click(); }
  function importData(e) { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=evt=>{ saveLogs(JSON.parse(evt.target.result).map(l=>({...l,date:cleanDate(l.date)}))); location.reload(); }; r.readAsText(f); } }

  // Chart
  function updateDashboard(d) {
    document.querySelectorAll('.filter-btn-group button').forEach(b=>b.classList.remove('active'));
    document.getElementById(`btn-${d}`).classList.add('active');
    let dt=[...allLogs]; if(d!=='all') dt=dt.slice(0,d); dt.reverse();
    
    const lbs=dt.map(l=>l.date.slice(5));
    const ws=dt.map(l=>l.weight);
    const cs=dt.map(l=>l.calories||0);
    const wts=dt.map(l=>l.water||0);
    const exs=dt.map(l=>l.exercise_time||0);
    const h=document.getElementById('userHeight').value;
    const bmis=ws.map(w=>getBMI(w,h));

    // Avg
    const vW=ws.filter(w=>w); const vC=cs.filter(c=>c>0);
    document.getElementById('avgWeight').innerText = vW.length?(vW.reduce((a,b)=>a+b,0)/vW.length).toFixed(1):'--';
    document.getElementById('avgCalories').innerText = vC.length?Math.round(vC.reduce((a,b)=>a+b,0)/vC.length):'--';

    renderChart('weightChart', 'line', lbs, [{label:'é«”é‡',data:ws,borderColor:'#2e7d32',backgroundColor:'#2e7d3215',fill:true,tension:0.3}], {y:{beginAtZero:false}});
    renderChart('bmiChart', 'line', lbs, [{label:'BMI',data:bmis,borderColor:'#8e24aa',backgroundColor:'#8e24aa15',fill:true,tension:0.3}], {y:{beginAtZero:false,grace:'10%'}});
    renderChart('dietChart', 'bar', lbs, [
        {label:'å–æ°´',data:wts,backgroundColor:'#42a5f5',yAxisID:'y'},
        {label:'ç†±é‡',data:cs,type:'line',borderColor:'#ffa726',yAxisID:'y1',tension:0.3}
    ], {y:{position:'left'},y1:{position:'right',grid:{drawOnChartArea:false}}});
    renderChart('exerciseChart', 'bar', lbs, [{label:'é‹å‹•(åˆ†)',data:exs,backgroundColor:'#ef5350'}]);
  }

  function renderChart(id, type, labels, datasets, scales={y:{beginAtZero:true},x:{grid:{display:false}}}) {
      const ctx = document.getElementById(id).getContext('2d');
      if(charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, { type, data: { labels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales } });
  }

  if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
</script>
</body>
</html>
